<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Interventi</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">

<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
  h1 { text-align: center; margin-top: 20px; }
  .btn-container { text-align: center; margin: 20px 0; }
  button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: #fff; }
  .btn-inizio { background: #4CAF50; }
  .btn-fine { background: #F44336; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
  .stats { margin: 20px; background: #fff; padding: 10px; border-radius: 5px; }
  
  /* Sidebar */
  .sidebar {
    height: 100%; width: 0; position: fixed; z-index: 1; top: 0; left: 0;
    background-color: #333; overflow-x: hidden; transition: 0.3s; padding-top: 60px;
  }
  .sidebar a, .sidebar button {
    padding: 10px 15px; text-decoration: none; font-size: 18px;
    color: #fff; display: block; background: none; border: none; text-align: left; width: 100%;
    cursor: pointer;
  }
  .sidebar a:hover, .sidebar button:hover { background-color: #575757; }
  .sidebar .closebtn {
    position: absolute; top: 0; right: 10px; font-size: 30px;
  }
  #main { transition: margin-left 0.3s; padding: 20px; }
  .menu-btn { font-size: 20px; cursor: pointer; background: none; border: none; color: #333; }
  
  /* Login */
  #loginScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
    color: white; flex-direction: column;
  }
  #loginScreen input { padding: 10px; font-size: 16px; margin-top: 10px; }
  #loginScreen button { background: #2196F3; margin-top: 10px; }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Inserisci il tuo nome">
  <button onclick="login()">Entra</button>
</div>

<!-- Sidebar -->
<div id="mySidebar" class="sidebar">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">√ó</a>
  <button onclick="showStats('year')">üìÖ Interventi per anno</button>
  <button onclick="showStats('month')">üóìÔ∏è Interventi per mese</button>
  <button onclick="exportData()">üì§ Esporta dati</button>
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(event)">
  <button onclick="document.getElementById('fileInput').click()">üì• Importa dati</button>
  <button onclick="showClassifica()">üèÜ Classifica</button>
</div>

<!-- Main Content -->
<div id="main">
  <button class="menu-btn" onclick="openNav()">‚ò∞ Menu</button>
  <h1>Registro Interventi</h1>
  <div class="btn-container">
    <button class="btn-inizio" onclick="addInizio()">Inizio intervento</button>
    <button class="btn-fine" onclick="addFine()">Fine intervento</button>
  </div>
  <div class="stats">
    <p><b>Totale interventi:</b> <span id="totalCount">0</span></p>
  </div>
  <table>
    <thead>
      <tr>
        <th>Data inizio</th>
        <th>Ora inizio</th>
        <th>Data fine</th>
        <th>Ora fine</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
let allData = JSON.parse(localStorage.getItem('multiUtenteInterventi')) || {};
let currentUser = null;
let tempInizio = null; // memorizza inizio corrente prima di chiudere intervento

function login() {
  const name = document.getElementById('username').value.trim();
  if (!name) { alert("Inserisci un nome utente!"); return; }
  currentUser = name;
  if (!allData[currentUser]) allData[currentUser] = [];
  saveAll();
  document.getElementById('loginScreen').style.display = 'none';
  renderTable();
}

function saveAll() {
  localStorage.setItem('multiUtenteInterventi', JSON.stringify(allData));
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  allData[currentUser].forEach(item => {
    const row = `<tr>
      <td>${item.dataInizio || ''}</td>
      <td>${item.oraInizio || ''}</td>
      <td>${item.dataFine || ''}</td>
      <td>${item.oraFine || ''}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
  document.getElementById('totalCount').innerText = allData[currentUser].length;
}

function addInizio() {
  if (tempInizio) { alert("Hai gi√† un intervento in corso!"); return; }
  const now = new Date();
  tempInizio = {
    dataInizio: now.toLocaleDateString('it-IT'),
    oraInizio: now.toLocaleTimeString('it-IT'),
    dataFine: '',
    oraFine: ''
  };
}

function addFine() {
  if (!tempInizio) { alert("Devi avviare un intervento prima di terminarlo!"); return; }
  const now = new Date();
  tempInizio.dataFine = now.toLocaleDateString('it-IT');
  tempInizio.oraFine = now.toLocaleTimeString('it-IT');
  allData[currentUser].push(tempInizio);
  tempInizio = null;
  saveAll();
  renderTable();
}

function showStats(mode) {
  let counts = {};
  allData[currentUser].forEach(i => {
    if (mode === 'year') {
      const year = i.dataInizio.split('/')[2];
      counts[year] = (counts[year] || 0) + 1;
    } else if (mode === 'month') {
      const [day, month, year] = i.dataInizio.split('/');
      const key = `${month}/${year}`;
      counts[key] = (counts[key] || 0) + 1;
    }
  });
  alert(mode === 'year' ? "Interventi per anno:\n" + JSON.stringify(counts, null, 2)
                        : "Interventi per mese:\n" + JSON.stringify(counts, null, 2));
}

function exportData() {
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'interventi.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (typeof data === 'object') {
        allData = data;
        saveAll();
        renderTable();
      } else {
        alert('Il file non √® valido.');
      }
    } catch {
      alert('Errore nella lettura del file.');
    }
  };
  reader.readAsText(file);
}

function showClassifica() {
  let arr = [];
  for (let user in allData) {
    arr.push({ utente: user, count: allData[user].length });
  }
  arr.sort((a,b) => b.count - a.count);
  let text = "Classifica:\n";
  arr.forEach((u, idx) => {
    text += `${idx+1}. ${u.utente} - ${u.count} interventi\n`;
  });
  alert(text);
}

function openNav() {
  document.getElementById("mySidebar").style.width = "250px";
  document.getElementById("main").style.marginLeft = "250px";
}

function closeNav() {
  document.getElementById("mySidebar").style.width = "0";
  document.getElementById("main").style.marginLeft= "0";
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
